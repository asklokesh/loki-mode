# Loki Mode Docker Compose (v6.0.0)
# Usage: docker-compose run loki start
# Note: version key removed - deprecated in Docker Compose v2+

services:
  loki:
    build: .
    image: loki-mode:latest
    volumes:
      # Mount current directory as workspace
      - .:/workspace:rw
      # Share git config for commits
      - ~/.gitconfig:/home/loki/.gitconfig:ro
      # Share SSH keys for git operations
      - ~/.ssh:/home/loki/.ssh:ro
      # Share GitHub CLI auth
      - ~/.config/gh:/home/loki/.config/gh:ro
    environment:
      # Loki Mode configuration
      - LOKI_NOTIFICATIONS=false  # No desktop notifications in container
      - LOKI_DASHBOARD=true
      - LOKI_DASHBOARD_PORT=57374
      - LOKI_CHROMA_HOST=chroma
      - LOKI_CHROMA_PORT=8000
      # Pass through GitHub token if set
      - GITHUB_TOKEN
      - GH_TOKEN
    ports:
      # Expose dashboard
      - "57374:57374"
    working_dir: /workspace
    stdin_open: true
    tty: true
    depends_on:
      chroma:
        condition: service_healthy

  chroma:
    image: chromadb/chroma:latest
    volumes:
      - chroma-data:/chroma/chroma
    ports:
      - "8100:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v2/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

volumes:
  chroma-data:

